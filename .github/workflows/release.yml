name: Auto Release After Deploy

on:
  workflow_run:
    workflows: ["Build and Deploy to GitHub Pages"]
    branches: [main]
    types:
      - completed

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get-latest-tag
        run: |
          # ç²å–æœ€æ–°çš„ tagï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ v0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

      - name: Generate new version
        id: generate-version
        run: |
          LATEST_TAG="${{ steps.get-latest-tag.outputs.latest_tag }}"
          # ç§»é™¤ v å‰ç¶´
          VERSION=${LATEST_TAG#v}
          # æ‹†åˆ†ç‰ˆæœ¬è™Ÿ
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}
          # è‡ªå‹•éå¢ patch ç‰ˆæœ¬
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v$MAJOR.$MINOR.$NEW_PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Get commits since last tag
        id: get-commits
        run: |
          LATEST_TAG="${{ steps.get-latest-tag.outputs.latest_tag }}"
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            # å¦‚æœæ˜¯ç¬¬ä¸€å€‹ releaseï¼Œç²å–æ‰€æœ‰ commits
            COMMITS=$(git log --oneline --pretty=format:"%s" | head -20)
          else
            # ç²å–è‡ªä¸Šæ¬¡ tag ä»¥ä¾†çš„ commits
            COMMITS=$(git log ${LATEST_TAG}..HEAD --oneline --pretty=format:"%s")
          fi
          
          # å°‡å¤šè¡Œ commits è½‰æ›ç‚ºå–®è¡Œï¼Œç”¨åˆ†è™Ÿåˆ†éš”
          COMMIT_LIST=""
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              if [ -n "$COMMIT_LIST" ]; then
                COMMIT_LIST="$COMMIT_LIST; $line"
              else
                COMMIT_LIST="$line"
              fi
            fi
          done <<< "$COMMITS"
          
          # å¦‚æœæ²’æœ‰æ–°çš„ commitsï¼Œä½¿ç”¨é»˜èªä¿¡æ¯
          if [ -z "$COMMIT_LIST" ]; then
            COMMIT_LIST="Minor updates and improvements"
          fi
          
          echo "commit_list=$COMMIT_LIST" >> $GITHUB_OUTPUT
          echo "Commits: $COMMIT_LIST"

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.generate-version.outputs.new_version }}"
          COMMIT_LIST="${{ steps.get-commits.outputs.commit_list }}"
          
          # å‰µå»º release
          gh release create "$NEW_VERSION" \
            --title "Release $NEW_VERSION" \
            --notes "$COMMIT_LIST" \
            --latest

      - name: Update deployment info
        run: |
          echo "âœ… Successfully created release ${{ steps.generate-version.outputs.new_version }}"
          echo "ğŸ“¦ Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.generate-version.outputs.new_version }}"
          echo "ğŸš€ Deployed to: https://${{ github.repository_owner }}.github.io/cword"