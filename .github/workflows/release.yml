name: Auto Release After Deploy

on:
  workflow_run:
    workflows: ["Build and Deploy to GitHub Pages"]
    branches: [main]
    types:
      - completed

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get-latest-tag
        run: |
          # ç²å–æœ€æ–°çš„ tagï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ v0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

      - name: Analyze commits and generate version
        id: generate-version
        run: |
          LATEST_TAG="${{ steps.get-latest-tag.outputs.latest_tag }}"
          # ç§»é™¤ v å‰ç¶´
          VERSION=${LATEST_TAG#v}
          # æ‹†åˆ†ç‰ˆæœ¬è™Ÿ
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}
          
          # ç²å– commit messages é€²è¡Œåˆ†æ
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --oneline --pretty=format:"%s" | head -20)
          else
            COMMITS=$(git log ${LATEST_TAG}..HEAD --oneline --pretty=format:"%s")
          fi
          
          # èªç¾©åŒ–ç‰ˆæœ¬åˆ¤æ–·é‚è¼¯
          BREAKING_CHANGE=false
          NEW_FEATURE=false
          BUG_FIX=false
          
          while IFS= read -r commit; do
            # æª¢æŸ¥ç ´å£æ€§è®Šæ›´ (MAJOR bump)
            if [[ "$commit" == *"BREAKING CHANGE"* ]] || [[ "$commit" =~ ^[^:]+!: ]] || [[ "$commit" == *"ğŸ’¥"* ]]; then
              BREAKING_CHANGE=true
            # æª¢æŸ¥æ–°åŠŸèƒ½ (MINOR bump)  
            elif [[ "$commit" =~ ^(feat|âœ¨|ğŸš€).* ]] || [[ "$commit" == *"feat:"* ]] || [[ "$commit" == *"feature:"* ]]; then
              NEW_FEATURE=true
            # æª¢æŸ¥ bug ä¿®å¾© (PATCH bump)
            elif [[ "$commit" =~ ^(fix|ğŸ›|ğŸ”§|âš¡).* ]] || [[ "$commit" == *"fix:"* ]] || [[ "$commit" == *"bugfix:"* ]]; then
              BUG_FIX=true
            fi
          done <<< "$COMMITS"
          
          # æ ¹æ“šèªç¾©åŒ–ç‰ˆæœ¬è¦å‰‡è¨ˆç®—æ–°ç‰ˆæœ¬
          if [ "$BREAKING_CHANGE" = true ]; then
            # ç ´å£æ€§è®Šæ›´ï¼šéå¢ MAJORï¼Œé‡ç½® MINOR å’Œ PATCH
            NEW_MAJOR=$((MAJOR + 1))
            NEW_MINOR=0
            NEW_PATCH=0
            VERSION_TYPE="MAJOR (Breaking Changes)"
          elif [ "$NEW_FEATURE" = true ]; then
            # æ–°åŠŸèƒ½ï¼šéå¢ MINORï¼Œé‡ç½® PATCH
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
            VERSION_TYPE="MINOR (New Features)"
          elif [ "$BUG_FIX" = true ]; then
            # Bug ä¿®å¾©ï¼šéå¢ PATCH
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
            VERSION_TYPE="PATCH (Bug Fixes)"
          else
            # å…¶ä»–è®Šæ›´ï¼šéå¢ PATCH
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
            VERSION_TYPE="PATCH (Other Changes)"
          fi
          
          NEW_VERSION="v$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION ($VERSION_TYPE)"

      - name: Get commits since last tag
        id: get-commits
        run: |
          LATEST_TAG="${{ steps.get-latest-tag.outputs.latest_tag }}"
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            # å¦‚æœæ˜¯ç¬¬ä¸€å€‹ releaseï¼Œç²å–æ‰€æœ‰ commits
            COMMITS=$(git log --oneline --pretty=format:"%s" | head -20)
          else
            # ç²å–è‡ªä¸Šæ¬¡ tag ä»¥ä¾†çš„ commits
            COMMITS=$(git log ${LATEST_TAG}..HEAD --oneline --pretty=format:"%s")
          fi
          
          # å°‡ commits æ ¼å¼åŒ–ç‚ºåˆ—è¡¨ï¼Œä¸¦è™•ç†ç‰¹æ®Šå­—ç¬¦
          COMMIT_LIST=""
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              # æ¸…ç†å¯èƒ½å°è‡´å•é¡Œçš„ç‰¹æ®Šå­—ç¬¦
              clean_line=$(echo "$line" | sed 's/["`$\\]/\\&/g')
              if [ -n "$COMMIT_LIST" ]; then
                COMMIT_LIST="${COMMIT_LIST}\n- ${clean_line}"
              else
                COMMIT_LIST="- ${clean_line}"
              fi
            fi
          done <<< "$COMMITS"
          
          # å¦‚æœæ²’æœ‰æ–°çš„ commitsï¼Œä½¿ç”¨é»˜èªä¿¡æ¯
          if [ -z "$COMMIT_LIST" ]; then
            COMMIT_LIST="- Minor updates and improvements"
          fi
          
          # ä½¿ç”¨ EOF ä¾†è™•ç†å¤šè¡Œè¼¸å‡º
          {
            echo "commit_list<<EOF"
            echo -e "$COMMIT_LIST"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          echo "Commits: $COMMIT_LIST"

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.generate-version.outputs.new_version }}"
          VERSION_TYPE="${{ steps.generate-version.outputs.version_type }}"
          COMMIT_LIST="${{ steps.get-commits.outputs.commit_list }}"
          
          # å‰µå»º release notes æ–‡ä»¶
          echo "## ${VERSION_TYPE}" > release_notes.md
          echo "" >> release_notes.md
          echo "## Changes" >> release_notes.md
          echo -e "${COMMIT_LIST}" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "ğŸš€ **Deployed to**: https://${{ github.repository_owner }}.github.io/cword" >> release_notes.md
          
          # å‰µå»º release
          gh release create "$NEW_VERSION" \
            --title "Release $NEW_VERSION" \
            --notes-file release_notes.md \
            --latest

      - name: Update deployment info
        run: |
          echo "âœ… Successfully created release ${{ steps.generate-version.outputs.new_version }}"
          echo "ğŸ“¦ Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.generate-version.outputs.new_version }}"
          echo "ğŸš€ Deployed to: https://${{ github.repository_owner }}.github.io/cword"